<p-toast />
<app-loading-spinner [loading]="loading()" />
<div>
    <div class="flex mb-4">
        <div class="card flex flex-col gap-4 w-full">
            <div class="flex flex-row gap-2">
                <div class="flex flex-wrap gap-1 w-1/3">
                    <p-button label="{{ 'common.all' | translate}}" icon="pi pi-list"
                        [severity]="selectedActivityType === undefined ? 'primary' : 'secondary'"
                        (onClick)="filterActivityType(undefined)" />
                    <p-button label="{{ 'common.call' | translate}}" icon="pi pi-phone"
                        [severity]="selectedActivityType === 1 ? 'primary' : 'secondary'"
                        (onClick)="filterActivityType(1)" />
                    <p-button label="{{ 'common.meeting' | translate}}" icon="pi pi-users"
                        [severity]="selectedActivityType === 2 ? 'primary' : 'secondary'"
                        (onClick)="filterActivityType(2)" />
                    <p-button label="{{ 'common.task' | translate}}" icon="pi pi-check-square"
                        [severity]="selectedActivityType === 3 ? 'primary' : 'secondary'"
                        (onClick)="filterActivityType(3)" />
                </div>
                <div class="flex flex-wrap gap-1 w-2/3 justify-end">
                    <p-button label="{{ 'common.all' | translate}}" icon="pi pi-list"
                        [severity]="selectedInterval === undefined ? 'primary' : 'secondary'"
                        (onClick)="filterSelectedInterval(undefined)" />
                    <p-button label="{{ 'common.today' | translate}}" icon="pi pi-calendar"
                        [severity]="selectedInterval === 1 ? 'primary' : 'secondary'"
                        (onClick)="filterSelectedInterval(1)" />
                    <p-button label="{{ 'common.tomorrow' | translate}}" icon="pi pi-calendar"
                        [severity]="selectedInterval === 2 ? 'primary' : 'secondary'"
                        (onClick)="filterSelectedInterval(2)" />
                    <p-button label="{{ 'common.this_week' | translate}}" icon="pi pi-calendar"
                        [severity]="selectedInterval === 3 ? 'primary' : 'secondary'"
                        (onClick)="filterSelectedInterval(3)" />
                    <p-button label="{{ 'common.next_week' | translate}}" icon="pi pi-calendar"
                        [severity]="selectedInterval === 4 ? 'primary' : 'secondary'"
                        (onClick)="filterSelectedInterval(4)" />
                    <p-button label="{{ 'common.overdue' | translate}}" icon="pi pi-clock"
                        [severity]="selectedInterval === 5 ? 'primary' : 'secondary'"
                        (onClick)="filterSelectedInterval(5)" />
                    <p-button label="{{ 'common.done' | translate}}" icon="pi pi-check-circle"
                        [severity]="selectedInterval === 6 ? 'primary' : 'secondary'"
                        (onClick)="filterSelectedInterval(6)" />
                </div>
            </div>
            <div class="flex flex-row gap-2">
                <div class="flex flex-wrap gap-1 w-full">
                    <p-message severity="info" class="mr-2">{{'activities.total_activities' | translate}}:
                        {{totalRecords()}}</p-message>
                    <p-button label="{{ 'activities.add_activity' | translate}}" icon="pi pi-plus-circle"
                        severity="secondary" (onClick)="openNew()" />
                </div>
                <div class="flex flex-wrap gap-1 w-full justify-end">
                    <p-button label="{{ 'common.reset' | translate}}" icon="pi pi-refresh" severity="secondary"
                        (onClick)="resetFilters()" class="mr-2" />
                    <div class="font-semibold text-lg mr-2">{{ 'activities.users' | translate }}</div>
                    <p-autocomplete [(ngModel)]="selectedUser" [suggestions]="usersAutoFilteredValue" optionLabel="name"
                        placeholder="{{ 'common.search' | translate }}" dropdown display="chip"
                        (completeMethod)="filterUsers($event)" appendTo="body" (onSelect)="filterActivityType()"
                        (onClear)="filterUserActivities()" />

                </div>

            </div>
        </div>
    </div>

    <p-table #dt [value]="activities()" [rows]="tableRowsCount()" [paginator]="true" [lazy]="true"
        (onLazyLoad)="loadActivities($event)" [totalRecords]="totalRecords()" [rowHover]="true" dataKey="id"
        [tableStyle]="{'min-width': '1200px'}"
        currentPageReportTemplate="{{ 'common.showing' | translate }} {first} {{ 'common.to' | translate }} {last} {{ 'common.of' | translate }} {totalRecords} {{ 'activities.activities' | translate }}"
        [showCurrentPageReport]="true" [rowsPerPageOptions]="[5, 10, 20, 30]">
        <ng-template #caption>
            <div class="flex items-center justify-between">
                <h5 class="m-0">{{'activities.title' | translate}}</h5>
            </div>
        </ng-template>
        <ng-template #header>
            <tr>
                <th style="width: 200px;">{{ 'activities.subject' | translate}}</th>
                <th>{{ 'activities.type' | translate}}</th>
                <th>{{ 'activities.created_by' | translate}}</th>
                <th>{{ 'activities.assignee' | translate}}</th>
                <th>{{ 'activities.due_date' | translate}}</th>
                <th>{{ 'activities.created_on' | translate}}</th>
                <th>{{ 'activities.person_name' | translate}}</th>
                <th>{{ 'activities.organization_name' | translate}}</th>
                <th>{{ 'activities.deal_name' | translate}}</th>
                <!-- <th style="width: 300px;">{{ 'activities.notes' | translate}}</th> -->
                <th>{{ 'activities.status' | translate}}</th>
                <th>{{ 'common.edit' | translate}}</th>
            </tr>
        </ng-template>
        <ng-template #body let-activity>
            <tr>
                <td style="word-break: break-word;">{{ activity.subject }}</td>
                <td>
                    <div [ngSwitch]="activity.activityTypeCode" class="flex items-center">
                        <i *ngSwitchCase="'C'" class="pi pi-phone mr-2" [pTooltip]="'activities.call' | translate"></i>
                        <i *ngSwitchCase="'M'" class="pi pi-users mr-2"
                            [pTooltip]="'activities.meeting' | translate"></i>
                        <i *ngSwitchCase="'T'" class="pi pi-check-square mr-2"
                            [pTooltip]="'activities.task' | translate"></i>
                    </div>
                </td>
                <td>{{ activity.createdBy }}</td>
                <td>{{ activity.assigneeName }}</td>
                <td>{{ activity.dueDate | date: 'shortDate' }}</td>
                <td>{{ activity.createdOn | date: 'shortDate' }}</td>
                <td>{{ activity.objectType === 'P' ? activity.objectName : '' }}</td>
                <td>{{activity.objectType === 'O' ? activity.objectName :''}}</td>
                <td>{{ activity.objectType === 'D' ? activity.objectName :''}}</td>
                <!-- <td style="word-break: break-word;">{{ activity.notes }}</td> -->
                <td><i [class]="activity.status === 'D'? 'pi pi pi-check-circle' : 'pi pi pi-check-square'"
                        [style]="{'font-size': '1.5rem', 'color': activity.status === 'D'? 'green' : 'purple'}"
                        [pTooltip]="activity.status === 'D' ? ('common.done' | translate) : ('common.in_progress' | translate)"
                        tooltipPosition="top"></i></td>
                <td>
                    <p-button icon="pi pi-pencil" [rounded]="true" [outlined]="true" (click)="editActivity(activity)" />
                </td>
            </tr>
        </ng-template>
    </p-table>


    <p-dialog [(visible)]="activityDialog" [style]="{ width: '600px' }"
        [header]="activity ? (activity.activityId ? ('activities.edit_activity' | translate) : ('activities.new_activity' | translate)) : ''"
        [modal]="true" >
        <ng-template #content>
            <div class="flex flex-col gap-4"  >
                <div class="flex flex-row gap-2">
                    <p-button icon="pi pi-phone" [text]="activity.activityTypeId !== 1"
                        pTooltip="{{'activities.call' | translate}}"
                        [severity]="activity.activityTypeId === 1 ? 'primary' : 'secondary'"
                        (click)="onChangeActivityType(1)" [disabled]="activity.status === 'D'"/>
                    <p-button icon="pi pi-users" [text]="activity.activityTypeId !== 2"
                        pTooltip="{{'activities.meeting' | translate}}"
                        [severity]="activity.activityTypeId === 2 ? 'primary' : 'secondary'"
                        (click)="onChangeActivityType(2)" [disabled]="activity.status === 'D'"/>
                    <p-button icon="pi pi-check-square" [text]="activity.activityTypeId !== 3"
                        pTooltip="{{'activities.task' | translate}}"
                        [severity]="activity.activityTypeId === 3 ? 'primary' : 'secondary'"
                        (click)="onChangeActivityType(3)" [disabled]="activity.status === 'D'"/>
                </div>
                <div class="flex flex-row gap-6">
                    <div class="flex flex-col gap-4 w-1/2">
                        <div class="flex flex-col ">
                            <label for="subject" class="block font-bold mb-3">{{ 'activities.subject' | translate
                                }} *</label>
                            <input type="text" pInputText id="subject" [(ngModel)]="activity.subject" autofocus fluid 
                            [disabled]="activity.status === 'D'"/>
                        </div>
                        <div class="flex flex-col">
                            <label class="block font-bold mb-3">{{ 'activities.due_date' | translate }} *</label>
                            <p-datepicker [showIcon]="true" [showButtonBar]="true" [(ngModel)]="activity.dueDate" 
                            [disabled]="activity.status === 'D'"/>
                        </div>
                        <div class="flex flex-col">
                            <label class="block font-bold mb-3">{{ 'activities.assignee' | translate }} *</label>
                            <p-autocomplete [(ngModel)]="activity.assignee" [suggestions]="usersAutoFilteredValue"
                                optionLabel="name" placeholder="{{ 'common.search' | translate }}" dropdown
                                display="chip" (completeMethod)="filterUsers($event)" appendTo="body" 
                                [disabled]="activity.status === 'D'"/>
                        </div>
                    </div>
                    <div class="flex flex-col gap-4 w-1/2">
                        <div class="flex flex-col">
                            <label class="block font-bold mb-3">{{ 'activities.person' | translate }}</label>
                            <p-autocomplete [(ngModel)]="selectedPerson" [suggestions]="personsAutoFilteredValue"
                                optionLabel="name" placeholder="{{ 'common.search' | translate }}" dropdown
                                (completeMethod)="filterPersons($event)" (onSelect)="onObjectSelect($event.value, 'P')"
                                (onClear)="onObjectClear()" [disabled]="!!selectedDeal || !!selectedOrganization || activity.status === 'D'"
                                appendTo="body" />
                        </div>
                        <div class="flex flex-col">
                            <label class="block font-bold mb-3">{{ 'activities.deal' | translate }}</label>
                            <p-autocomplete [(ngModel)]="selectedDeal" [suggestions]="dealsAutoFilteredValue"
                                optionLabel="name" placeholder="{{ 'common.search' | translate }}" dropdown
                                (completeMethod)="filterDeals($event)" (onSelect)="onObjectSelect($event.value, 'D')"
                                (onClear)="onObjectClear()" [disabled]="!!selectedPerson || !!selectedOrganization || activity.status === 'D'"
                                appendTo="body" />
                        </div>
                        <div class="flex flex-col">
                            <label class="block font-bold mb-3">{{ 'activities.organization' | translate }}</label>
                            <p-autocomplete [(ngModel)]="selectedOrganization"
                                [suggestions]="organizationsAutoFilteredValue" optionLabel="name"
                                placeholder="{{ 'common.search' | translate }}" dropdown
                                (completeMethod)="filterOrganizations($event)"
                                (onSelect)="onObjectSelect($event.value, 'O')" (onClear)="onObjectClear()"
                                [disabled]="!!selectedPerson || !!selectedDeal || activity.status === 'D'" appendTo="body" />
                        </div>
                    </div>
                </div>
                <div>
                    <label for="notes" class="block font-bold mb-3">{{ 'activities.notes' | translate }}</label>
                    <textarea id="notes" pTextarea [(ngModel)]="activity.notes" rows="3" cols="20" fluid
                    [disabled]="activity.status === 'D'"></textarea>
                </div>
            </div>
        </ng-template>
        <ng-template #footer>
            <label for="checkbox" class="block font-bold mt-2">{{ 'activities.mark_as_done' | translate }}</label>
            <p-checkbox name="checkbox" [(ngModel)]="activity.status" [binary]="true" [trueValue]="'D'"
                [falseValue]="'I'" class="mt-2" [disabled]="activity.status === 'D'"/>
            <p-button label="{{ 'common.cancel' | translate }}" icon="pi pi-times" text (click)="hideDialog()" />
            <p-button label="{{ 'common.save' | translate }}" icon="pi pi-save" (click)="saveActivity()" />
        </ng-template>
    </p-dialog>
</div>